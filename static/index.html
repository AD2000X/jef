<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEF Analysis</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .slider-container {
            margin: 20px 0;
            width: 100%;
        }
        .input-row {
            margin: 10px 0;
        }
        #plotDiv {
            min-height: 400px;
        }
        .sidebar {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Panel -->
            <div class="col-md-4 sidebar">
                <h3>Parameters</h3>
                <div class="slider-container">
                    <label>Age Range</label>
                    <div class="d-flex">
                        <input type="range" class="form-range" id="ageMin" min="18" max="87" value="30">
                        <input type="range" class="form-range" id="ageMax" min="18" max="87" value="45">
                    </div>
                    <small class="text-muted">Selected: <span id="ageRange">30-45</span></small>
                </div>

                <div class="slider-container">
                    <label>IQ Range</label>
                    <div class="d-flex">
                        <input type="range" class="form-range" id="iqMin" min="73" max="128" value="85">
                        <input type="range" class="form-range" id="iqMax" min="73" max="128" value="115">
                    </div>
                    <small class="text-muted">Selected: <span id="iqRange">85-115</span></small>
                </div>

                <!-- Score Inputs -->
                <div class="row">
                    <div class="col-6">
                        <div class="input-row">
                            <label>PL</label>
                            <input type="number" id="pl" class="form-control" value="50">
                        </div>
                        <div class="input-row">
                            <label>ST</label>
                            <input type="number" id="st" class="form-control" value="50">
                        </div>
                        <div class="input-row">
                            <label>AT</label>
                            <input type="number" id="at" class="form-control" value="0">
                        </div>
                        <div class="input-row">
                            <label>ABPM</label>
                            <input type="number" id="abpm" class="form-control" value="75">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="input-row">
                            <label>PR</label>
                            <input type="number" id="pr" class="form-control" value="100">
                        </div>
                        <div class="input-row">
                            <label>CT</label>
                            <input type="number" id="ct" class="form-control" value="25">
                        </div>
                        <div class="input-row">
                            <label>EBPM</label>
                            <input type="number" id="ebpm" class="form-control" value="25">
                        </div>
                        <div class="input-row">
                            <label>TBPM</label>
                            <input type="number" id="tbpm" class="form-control" value="50">
                        </div>
                    </div>
                </div>
                <div class="input-row">
                    <label>AVG</label>
                    <input type="number" id="avg" class="form-control" value="46.9">
                </div>
                <button id="calculateBtn" class="btn btn-primary mt-3">Calculate</button>
            </div>

            <!-- Main Panel -->
            <div class="col-md-8">
                <div id="plotDiv"></div>
            </div>
        </div>
    </div>

    <script>
        // Update range displays
        function updateRangeDisplay() {
            document.getElementById('ageRange').textContent = 
                `${document.getElementById('ageMin').value}-${document.getElementById('ageMax').value}`;
            document.getElementById('iqRange').textContent = 
                `${document.getElementById('iqMin').value}-${document.getElementById('iqMax').value}`;
        }

        // Add event listeners for range inputs
        ['ageMin', 'ageMax', 'iqMin', 'iqMax'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateRangeDisplay);
        });

        document.getElementById('calculateBtn').addEventListener('click', async () => {
            const data = {
                age_range: [
                    parseInt(document.getElementById('ageMin').value),
                    parseInt(document.getElementById('ageMax').value)
                ],
                iq_range: [
                    parseInt(document.getElementById('iqMin').value),
                    parseInt(document.getElementById('iqMax').value)
                ],
                scores: {
                    PL: parseFloat(document.getElementById('pl').value),
                    PR: parseFloat(document.getElementById('pr').value),
                    ST: parseFloat(document.getElementById('st').value),
                    CT: parseFloat(document.getElementById('ct').value),
                    AT: parseFloat(document.getElementById('at').value),
                    EBPM: parseFloat(document.getElementById('ebpm').value),
                    ABPM: parseFloat(document.getElementById('abpm').value),
                    TBPM: parseFloat(document.getElementById('tbpm').value),
                    AVG: parseFloat(document.getElementById('avg').value)
                }
            };

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                // Prepare plot data
                const plotData = [{
                    type: 'bar',
                    x: Object.keys(result.z_scores),
                    y: Object.values(result.z_scores),
                    marker: {
                        color: '#CC3333',
                        line: { color: 'black', width: 1 }
                    },
                    width: 0.6
                }];

                const layout = {
                    title: '',
                    yaxis: {
                        title: 'Z-score',
                        range: [-5, 1],
                        zeroline: true,
                        zerolinecolor: 'black',
                        zerolinewidth: 0.5
                    },
                    xaxis: {
                        position: 'top'
                    },
                    shapes: [{
                        type: 'line',
                        x0: -0.5,
                        x1: Object.keys(result.z_scores).length - 0.5,
                        y0: -2,
                        y1: -2,
                        line: {
                            color: '#0099FF',
                            width: 2,
                            dash: 'dash'
                        }
                    }],
                    annotations: [
                        {
                            x: 1,
                            y: -4.8,
                            text: `N = ${result.n_samples}`,
                            showarrow: false,
                            xanchor: 'right'
                        },
                        {
                            x: 1,
                            y: -4.5,
                            text: `Age range: ${result.age_range[0]} ~ ${result.age_range[1]}`,
                            showarrow: false,
                            xanchor: 'right'
                        },
                        {
                            x: 1,
                            y: -4.2,
                            text: `IQ range: ${result.iq_range[0]} ~ ${result.iq_range[1]}`,
                            showarrow: false,
                            xanchor: 'right'
                        }
                    ],
                    showlegend: false,
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)'
                };

                Plotly.newPlot('plotDiv', plotData, layout);
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Initialize range displays
        updateRangeDisplay();
    </script>
</body>
</html>
